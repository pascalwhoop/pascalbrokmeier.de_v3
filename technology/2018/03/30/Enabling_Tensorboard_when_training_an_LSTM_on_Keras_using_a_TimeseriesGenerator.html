<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Enabling Tensorboard to see what&#39;s happening during training of an LSTM on Keras using a Timeseries Generator</title>
  <meta name="description" content="Learning neural networks is still very messy, so without tools such as tensorboard, it would be really hard to really comprehend what is happening. Unfortuna...">

  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/font-awesome.min.css">
  <link rel="canonical" href="http://pascalbrokmeier.de">
  <link rel="alternate" type="application/rss+xml" title="Homepage of Pascal Brokmeier" href="/feed.xml">

  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-55919824-7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-55919824-7');
</script>

  <!-- Begin Jekyll SEO tag v2.6.0 -->
<title>Enabling Tensorboard to see what’s happening during training of an LSTM on Keras using a Timeseries Generator | Homepage of Pascal Brokmeier</title>
<meta name="generator" content="Jekyll v3.8.4" />
<meta property="og:title" content="Enabling Tensorboard to see what’s happening during training of an LSTM on Keras using a Timeseries Generator" />
<meta name="author" content="Pascal Brokmeier" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Learning neural networks is still very messy, so without tools such as tensorboard, it would be really hard to really comprehend what is happening. Unfortunately, it’s not super easy to get tensorboard working out-of-the-box with Keras when training certain structures." />
<meta property="og:description" content="Learning neural networks is still very messy, so without tools such as tensorboard, it would be really hard to really comprehend what is happening. Unfortunately, it’s not super easy to get tensorboard working out-of-the-box with Keras when training certain structures." />
<link rel="canonical" href="http://pascalbrokmeier.de/technology/2018/03/30/Enabling_Tensorboard_when_training_an_LSTM_on_Keras_using_a_TimeseriesGenerator.html" />
<meta property="og:url" content="http://pascalbrokmeier.de/technology/2018/03/30/Enabling_Tensorboard_when_training_an_LSTM_on_Keras_using_a_TimeseriesGenerator.html" />
<meta property="og:site_name" content="Homepage of Pascal Brokmeier" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-03-30T00:00:00+02:00" />
<script type="application/ld+json">
{"description":"Learning neural networks is still very messy, so without tools such as tensorboard, it would be really hard to really comprehend what is happening. Unfortunately, it’s not super easy to get tensorboard working out-of-the-box with Keras when training certain structures.","@type":"BlogPosting","headline":"Enabling Tensorboard to see what’s happening during training of an LSTM on Keras using a Timeseries Generator","dateModified":"2018-03-30T00:00:00+02:00","url":"http://pascalbrokmeier.de/technology/2018/03/30/Enabling_Tensorboard_when_training_an_LSTM_on_Keras_using_a_TimeseriesGenerator.html","datePublished":"2018-03-30T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://pascalbrokmeier.de/technology/2018/03/30/Enabling_Tensorboard_when_training_an_LSTM_on_Keras_using_a_TimeseriesGenerator.html"},"author":{"@type":"Person","name":"Pascal Brokmeier"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <!--<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style media="screen">
      #netlify-identity-widget{
          z-index: 999;
      }
  </style>-->
</head>


  <body>
      <!-- Header -->
      <header id="header" class="reveal">
    <a href="/index.html" class="logo"><strong>PB</strong></a>
    <nav>
        <a href="#menu">Menu</a>
    </nav>
</header>
<!-- <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">Homepage of Pascal Brokmeier</a>

    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
          
            
            
            <a class="page-link" href="/about/">About me</a>
            
          
            
            
            <a class="page-link" href="/contact/">Get in contact</a>
            
          
            
            
          
            
            
            <a class="page-link" href="/legal/">Impressum</a>
            
          
            
            
          
            
            
            <a class="page-link" href="/portfolio/">Portfolio</a>
            
          
            
            
            <a class="page-link" href="/posts/">Blog</a>
            
          
            
            
            <a class="page-link" href="/readinglist/">Reading list</a>
            
          
            
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header> -->

      <div id="wrapper">

          <!--  Menu  -->
          <!-- Menu -->
    <nav id="menu">
        <ul class="links">
            <li><a href="/">Home</a></li>
            <li><a href="/posts">Blog</a></li>
            <!--<li><a href="portfolio">Portfolio</a></li>-->
            <li><a href="/about">About me</a></li>
            <li><a href="/contact">Contact</a></li>
            <li><a href="https://unsplash.com/@pascalwhoop" target="_blank" class="">Photography</a></li>
            <li><a href="https://github.com/pascalwhoop" target="_blank" class="">Github</a></li>
            <li><a href="/admin">Login</a></li>
        </ul>

    </nav>


          <section id="post" class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="banner">
        
        
        
        <img src="http://pascalbrokmeier.de/images/posts/2018-03-30/cover.jpg"   alt="cover for post" width="2000" height="1000" crossorigin="anonymous" />
        
        
    </div>


    <div class="inner">
        <header class="major">
            <h1 itemprop="name headline">Enabling Tensorboard to see what&#39;s happening during training of an LSTM on Keras using a Timeseries Generator</h1>
            <p class="post-meta">
                <time datetime="2018-03-30T00:00:00+02:00" itemprop="datePublished">
                    
                    Mar 30, 2018
                </time>
                
                • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Pascal Brokmeier</span></span>
                
            </p>
        </header>

        <div class="post-content" itemprop="articleBody">
            <p>Learning neural networks is still very messy, so without tools such as tensorboard, it would be really hard to really
comprehend what is happening. Unfortunately, it’s not super easy to get tensorboard working out-of-the-box with Keras
when training certain structures.</p>

<p>When running an LSTM learning algorithm on large datasets, it is sometimes needed to generate the sequences on the fly
and feed the data that is used to learn the algorithms in several steps. If the size of the data is large but the series
for each logical unit is small however, it is often not possible to run several epochs on the whole set but rather run
single epochs on each smaller unit.</p>

<p>In my specific case I was analyzing some 3GB of sequential forecast data and its corresponding realized data values. To
learn from historical data, it is necessary to let the LSTM see anything from up to 7 days before the current reading.
That equates to each sequence being equal to about <script type="math/tex">24 * 7</script> the size of the original data. That is clearly too much
to generate ahead of time and then just feed to the CPU from memory. So a different approach is needed. Because the
whole dataset cannot be fed to the LSTM directly however, I am using the <code class="highlighter-rouge">model.fit_generator</code> API of Keras. This allows
me to pass a <code class="highlighter-rouge">Sequence</code> object that generates Sequences from an underlying data array on the fly. This API doesn’t
support the <code class="highlighter-rouge">validation_split</code> flag, which requires me to pass a separate generator to the API for its validation steps.
However, this is not supported by Tensorflow (no generators allowed), which requires me to create a separate Tuple of
(X,Y) values that is in-memory and that can be used for validation. Since this doesn’t need to be so large, it fits into
memory.</p>

<p>My overall learning structure sort of looks as such</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">run_full_learning</span><span class="p">():</span>
    <span class="c1"># iterate over games (holding customer lists)
</span>    <span class="k">for</span> <span class="n">g_number</span><span class="p">,</span> <span class="n">game</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">GamesIterator</span><span class="p">()):</span>
        <span class="c1"># iterating over customers in game
</span>		<span class="c1"># sequences is [generator, validation_set]
</span>        <span class="k">for</span> <span class="n">sequences</span> <span class="ow">in</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">CustomerIterator</span><span class="p">(</span><span class="n">game</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">game</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">model</span><span class="o">.</span><span class="n">fit_with_generator</span><span class="p">(</span><span class="n">mdl</span><span class="p">,</span> <span class="n">sequences</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sequences</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">mdl</span><span class="o">.</span><span class="n">save_weights</span><span class="p">(</span><span class="s">"data/consume/game{}.HDF5"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">g_number</span><span class="p">))</span>
</code></pre></div></div>

<p>I train my model on every customer sequence which is some 2000 timesteps long and which has 17 features per timestep.
Every game holds about 200 customers and I have about 100 games. After training on every customer, tensorboard gets to
validate and calculate the loss after each epoch is done (and each epoch is one customer set being completed). The exact
train call of Keras is this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>model.fit_generator(train_generator,
                    steps_per_epoch=None,  #a generator size (aka one customer) is an epoch
                    epochs=1,
                    verbose=2,  #progress bar, 2 = line per epoch
                    callbacks=callbacks,
                    validation_data=validation_set,
                    #validation_steps=None,
                    class_weight=None,
                    max_queue_size=10,
                    workers=8,
                    use_multiprocessing=True,
                    shuffle=True,
                    initial_epoch=0)
</code></pre></div></div>

<p>To generate the validation set, I first used the <code class="highlighter-rouge">util.TimeseriesGenerator</code> to generate the sequences. But since I<br />
don’t actually want to feed a generator to tensorflow, I instead converted it back into an array that I can give to
Keras. This way, Tensorboard is happy about the fact that it is not receiving a generator and I am happy because I get
visual feedback.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	def generate_batches_for_customer(data, targets):
    	"""[keras docs](https://keras.io/preprocessing/sequence/#timeseriesgenerator)"""
    	return TimeseriesGenerator(data,
        	                       targets,
        	                       length=SEQUENCE_LENGTH,
        	                       sampling_rate=SAMPLING_RATE,
        	                       batch_size=BATCH_SIZE)
#...

     make_sequences(self, cutofa, data, targets):
        """given a cutoff and two data arrays, generate Sequences from it (one before cutoff one after"""
        training_sequence   = generate_batches_for_customer(np.array(data[:-cutoff]), np.array(targets[:-cutoff]))
        validation_sequence = generate_batches_for_customer(np.array(data[-cutoff:]), np.array(targets[-cutoff:]))
        return training_sequence, validation_sequence

    def get_next_pair(self):
        """pops the first of both arrays out and returns it"""
        data    = self.data_customers.pop(0)
        targets = self.targets_customers.pop(0)
        return data, targets

    def convert_sequence_to_set(self, sequence: Sequence):
        #this is a set of tuples. We need a tuple of sets...
        x = []
        y = []
        for i in range(sequence.length):
            batch = sequence[i]
            x.extend(batch[0])
            y.extend(batch[1])
        return np.array(x), np.array(y)
</code></pre></div></div>

<p>So to sum it up, it is possible to get Tensorboard going with util.Sequence from a TimeseriesGenerators, but it’s a
little messy as we first make a Sequence object and then drain it of all sequences to pass directly to the train method.
I guess a future API update will allow Sequence objects also when using a Tensorboard callback but for now this will do.</p>

        </div>
    </div>

</section>


      </div>

      <footer id="footer">
    <div class="inner">
        <h3>Homepage of Pascal Brokmeier</h3>
        <p>Check out my about page for more, read my blog or watch me code on YouTube or just take a picture of mine for your wallpaper. I share everything for free and really enjoy good conversations about meaningful topics. Let me know if you have something to talk about.
</p>
        <ul class="icons">

            
            <li><a href="mailto:public@pascalbrokmeier.de" class="icon alt fa-envelope"></a></li>
            
            
            <li><a href="https://twitter.com/PascalBrokmeier" class="icon alt fa-twitter" rel="me"><span class="label">Twitter</span></a>
            </li>
            
            
            <li><a href="https://github.com/pascalwhoop" class="icon alt fa-github" rel="me"><span class="label">GitHub</span></a>
            </li>
            
            <!--
            <li><a href="#" class="icon alt fa-facebook"><span class="label">Facebook</span></a></li>
            <li><a href="#" class="icon alt fa-instagram"><span class="label">Instagram</span></a></li>
            <li><a href="#" class="icon alt fa-linkedin"><span class="label">LinkedIn</span></a></li>
            -->

        </ul>
        <ul class="copyright">
            <li><span class="copyleft">&copy;</span>
                
                Homepage of Pascal Brokmeier
                
            </li>
            <li>Design: some of <a href="https://html5up.net">HTML5 UP</a> adopted by me</li>
            <li><a href="/sitemap.xml">Sitemap</a></li>
            <li><a href="/legal">Legal</a></li>
        </ul>
    </div>
</footer>

<script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>
<script src="/assets/js/jquery.scrolly.min.js"></script>
<script src="/assets/js/jquery.scrollex.min.js"></script>
<script src="/assets/js/skel.min.js"></script>
<script src="/assets/js/util.js"></script>
<script src="/assets/js/articles.js"></script>
<!--[if lte IE 8]>
<script  src="assets/js/ie/respond.min.js"></script><![endif]-->
<script src="/assets/js/main.js"></script>




  </body>

</html>
