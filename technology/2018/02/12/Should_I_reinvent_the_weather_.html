<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Should I reinvent the weather?</title>
  <meta name="description" content="In my journey towards a powertac agent I discovered the complexity behind the weather server and thought about adapting it to make it easily deployable in a ...">

  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/font-awesome.min.css">
  <link rel="canonical" href="http://pascalbrokmeier.de">
  <link rel="alternate" type="application/rss+xml" title="Homepage of Pascal Brokmeier" href="/feed.xml">

  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-55919824-7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-55919824-7');
</script>

  <!-- Begin Jekyll SEO tag v2.6.0 -->
<title>Should I reinvent the weather? | Homepage of Pascal Brokmeier</title>
<meta name="generator" content="Jekyll v3.8.4" />
<meta property="og:title" content="Should I reinvent the weather?" />
<meta name="author" content="Pascal Brokmeier" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In my journey towards a powertac agent I discovered the complexity behind the weather server and thought about adapting it to make it easily deployable in a container. Once it’s in a container, other teams could quickly start up an instance of their own without many dependencies (really just docker). But then I realized some oddities with the way …" />
<meta property="og:description" content="In my journey towards a powertac agent I discovered the complexity behind the weather server and thought about adapting it to make it easily deployable in a container. Once it’s in a container, other teams could quickly start up an instance of their own without many dependencies (really just docker). But then I realized some oddities with the way …" />
<link rel="canonical" href="http://pascalbrokmeier.de/technology/2018/02/12/Should_I_reinvent_the_weather_.html" />
<meta property="og:url" content="http://pascalbrokmeier.de/technology/2018/02/12/Should_I_reinvent_the_weather_.html" />
<meta property="og:site_name" content="Homepage of Pascal Brokmeier" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-02-12T00:00:00+01:00" />
<script type="application/ld+json">
{"description":"In my journey towards a powertac agent I discovered the complexity behind the weather server and thought about adapting it to make it easily deployable in a container. Once it’s in a container, other teams could quickly start up an instance of their own without many dependencies (really just docker). But then I realized some oddities with the way …","@type":"BlogPosting","headline":"Should I reinvent the weather?","dateModified":"2018-02-12T00:00:00+01:00","url":"http://pascalbrokmeier.de/technology/2018/02/12/Should_I_reinvent_the_weather_.html","datePublished":"2018-02-12T00:00:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://pascalbrokmeier.de/technology/2018/02/12/Should_I_reinvent_the_weather_.html"},"author":{"@type":"Person","name":"Pascal Brokmeier"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <!--<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style media="screen">
      #netlify-identity-widget{
          z-index: 999;
      }
  </style>-->
</head>


  <body>
      <!-- Header -->
      <header id="header" class="reveal">
    <a href="/index.html" class="logo"><strong>PB</strong></a>
    <nav>
        <a href="#menu">Menu</a>
    </nav>
</header>
<!-- <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">Homepage of Pascal Brokmeier</a>

    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
          
            
            
            <a class="page-link" href="/about/">About me</a>
            
          
            
            
            <a class="page-link" href="/contact/">Get in contact</a>
            
          
            
            
          
            
            
            <a class="page-link" href="/legal/">Impressum</a>
            
          
            
            
          
            
            
            <a class="page-link" href="/portfolio/">Portfolio</a>
            
          
            
            
            <a class="page-link" href="/posts/">Blog</a>
            
          
            
            
            <a class="page-link" href="/readinglist/">Reading list</a>
            
          
            
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header> -->

      <div id="wrapper">

          <!--  Menu  -->
          <!-- Menu -->
    <nav id="menu">
        <ul class="links">
            <li><a href="/">Home</a></li>
            <li><a href="/posts">Blog</a></li>
            <!--<li><a href="portfolio">Portfolio</a></li>-->
            <li><a href="/about">About me</a></li>
            <li><a href="/contact">Contact</a></li>
            <li><a href="https://unsplash.com/@pascalwhoop" target="_blank" class="">Photography</a></li>
            <li><a href="https://github.com/pascalwhoop" target="_blank" class="">Github</a></li>
            <li><a href="/admin">Login</a></li>
        </ul>

    </nav>


          <section id="post" class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="banner">
        
        
        
        <img src="http://pascalbrokmeier.de/images/posts/2018-02-12/cover.jpg"   alt="cover for post" width="2000" height="822" crossorigin="anonymous" />
        
        <a style="border-bottom: 0; background-color:black;color:white;text-decoration:none;padding:4px 6px;font-family:-apple-system, BlinkMacSystemFont, &quot;San Francisco&quot;, &quot;Helvetica Neue&quot;, Helvetica, Ubuntu, Roboto, Noto, &quot;Segoe UI&quot;, Arial, sans-serif;font-size:12px;font-weight:bold;line-height:1.2;display:inline-block;border-radius:3px;" href="http://unsplash.com/@nelucalator?utm_medium=referral&amp;utm_campaign=photographer-credit&amp;utm_content=creditBadge" target="_blank" rel="noopener noreferrer" title="Download free do whatever you want high-resolution photos from Igor Ovsyannykov"><span style="display:inline-block;padding:2px 3px;"><svg xmlns="http://www.w3.org/2000/svg" style="height:12px;width:auto;position:relative;vertical-align:middle;top:-1px;fill:white;" viewBox="0 0 32 32"><title></title><path d="M20.8 18.1c0 2.7-2.2 4.8-4.8 4.8s-4.8-2.1-4.8-4.8c0-2.7 2.2-4.8 4.8-4.8 2.7.1 4.8 2.2 4.8 4.8zm11.2-7.4v14.9c0 2.3-1.9 4.3-4.3 4.3h-23.4c-2.4 0-4.3-1.9-4.3-4.3v-15c0-2.3 1.9-4.3 4.3-4.3h3.7l.8-2.3c.4-1.1 1.7-2 2.9-2h8.6c1.2 0 2.5.9 2.9 2l.8 2.4h3.7c2.4 0 4.3 1.9 4.3 4.3zm-8.6 7.5c0-4.1-3.3-7.5-7.5-7.5-4.1 0-7.5 3.4-7.5 7.5s3.3 7.5 7.5 7.5c4.2-.1 7.5-3.4 7.5-7.5z"></path></svg></span><span style="display:inline-block;padding:2px 3px;">nelucalator on unsplash.com</span></a>

        
        
    </div>


    <div class="inner">
        <header class="major">
            <h1 itemprop="name headline">Should I reinvent the weather?</h1>
            <p class="post-meta">
                <time datetime="2018-02-12T00:00:00+01:00" itemprop="datePublished">
                    
                    Feb 12, 2018
                </time>
                
                • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Pascal Brokmeier</span></span>
                
            </p>
        </header>

        <div class="post-content" itemprop="articleBody">
            <p>In my journey towards a powertac agent I discovered the complexity behind the weather server and thought about adapting it to make it easily deployable in a container. Once it’s in a container, other teams could quickly start up an instance of their own without many dependencies (really just docker). But then I realized some oddities with the way it is set up. To generate an xml file (or alternatively serve them via REST), a <code class="highlighter-rouge">python - mysql - python - mysql - java - python</code> chain is set up. And to make it worse, all mysql commands are non-optimized atomic requests inside of loops in python. No bulking, no parallel processing etc.</p>

<p>Okay, let’s think about this. We are pulling 18 years of forecast data from the servers. That’s about 150k datapoints, which makes sense as we have 18 years with 24h per day. But how many points are we importing into the database?</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>START_DATE = "20090101" # YYYYMMDD of earliest report
END_DATE = "20111231" # YYYYMMDD of last report
</code></pre></div></div>

<p>so 3 years, aka 26298 datapoints. Now for each hour of these 3 years
<a href="https://github.com/powertac/powertac-weather-server/blob/master/scripts/create_forecast_data.py">this script</a> generates 24 forecasts for the upcoming 24 hours. Let’s do the math here:</p>

<script type="math/tex; mode=display">3 \times 365 \times 24 \times 24 = 630720</script>

<p>That’s all good and well though. The problem really lies in the way the code is structured.</p>

<h2 id="current-implementation-creating-deltas">Current implementation: Creating Deltas</h2>

<p>Let’s first look at the <code class="highlighter-rouge">create_forecast_deltas.py</code> file (with some added inline comments by me):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#imports ...

OUT_FILE = "deltas.txt"
MAX_ERROR = 0.0001
TOTAL = 1000000 # &lt;-- this one. 1Mio! it's the counter of a loop later
DELTAS = [
    0.5161445829244465,
    0.4997949220914800,
    #... len(DELTAS) = 24

]
TARGETS = [
    0.5161290323,
    1.6221198157
    #... len(TARGETS) = 24
]
</code></pre></div></div>
<p><img src="http://pascalbrokmeier.de/images/posts/2018-02-08/targets.png" alt="" width="397" height="271" crossorigin="anonymous" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#main moved above for ease of top-down readability.
def main():
    errors = [0.0] * len(TARGETS)
    current = 0

    with open(OUT_FILE, 'w') as f:
        f.write("")

    #this loop gets iterated over 24 times (len(TARGETS) break below)
    while True:
        #current = 0, 1, 2, 3, ...
        error = loop(current)

        #difference between MSE and target MSE (i.e. MSE is supposed to increase over 24h predicition period)
        diff = error - TARGETS[current]
        change = 1 - max(MAX_ERROR, abs(diff) / 5)

        #next big block: comparing MSE to targets. If not fitting, iterating millions of times AGAIN.
        print current, DELTAS[current], change
        print error, TARGETS[current]
        print ("%.6f" % diff),
        if diff &gt; MAX_ERROR:
            print "diff larger"
            DELTAS[current] = DELTAS[current] * change
        elif diff &lt; -MAX_ERROR:
            print "diff smaller"
            DELTAS[current] = DELTAS[current] / change
        else:   
            print "diff OK"
            with open(OUT_FILE, 'a') as f:
                f.write("%d %.16f\n" % (current, DELTAS[current]))
            errors[current] = error
            current += 1

        if current &gt;= len(TARGETS):
            break

    print
    print len(errors), len(DELTAS)
    print
    print errors
    print
    print DELTAS
</code></pre></div></div>

<p>The above block is not at all understandable to me. It seems as if the code is trying to achieve a DELTAS list that is <em>close</em> to a function resembling the derivative of the TARGETS (which are a log function) without being exact. Why this wasn’t just performed by taking 24 values of a log function and adding some noise to them, I don’t know.</p>

<p>The next function shows how a loop iterating over our <code class="highlighter-rouge">TOTAL</code> range (1 Mio.) and then iterating over current+1 which means 1, 2, 3, 4, 5 … iterations for each subsequent <code class="highlighter-rouge">loop(current)</code> call.</p>

<script type="math/tex; mode=display">\sum_{i=1}^{25}{i} * 1{.}000{.}000 = 300{.}000{.}000 \text{iterations}</script>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def loop(current):
    forecasts = []

    #1Mio times
    for _ in range(TOTAL):
        tau = 0
        temp = []
        for i in range(current+1):
            tau = tau + random.gauss(0, DELTAS[i])
            temp.append(tau)
        forecasts.append(temp)

    error = 0.0
    #mean squared error
    for forecast in forecasts:
        error += forecast[current] ** 2
    error = math.sqrt(error / len(forecasts))

    return error

</code></pre></div></div>

<p>Some sample output of the <code class="highlighter-rouge">create_forecast_deltas.py</code> script</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0 0.516144582924 0.9999
0.515986943719 0.5161290323
-0.000142 diff smaller

0 0.516196202545 0.9999
0.516100208138 0.5161290323
-0.000029 diff OK

1 0.499794922091 0.999807649737
0.717932257886 0.7188940092
-0.000962 diff smaller

1 0.499891076271 0.9999
0.719294262397 0.7188940092
0.000400 diff larger

1 0.499841087164 0.999847349058
0.718130754489 0.7188940092
-0.000763 diff smaller

1 0.499917400026 0.9999
0.718902314128 0.7188940092
0.000008 diff OK

2 0.488890089098 0.99970675704
0.868349453399 0.8698156682
-0.001466 diff smaller

2 0.489033494728 0.999823374688
0.868932541638 0.8698156682
-0.000883 diff smaller

2 0.48911988568 0.999660646651
0.868118901454 0.8698156682
-0.001697 diff smaller

2 0.489285926498 0.9999
0.87002069015 0.8698156682
0.000205 diff larger

2 0.489236997906 0.999709463393
0.868362985166 0.8698156682
-0.001453 diff smaller

2 0.489379180472 0.999886141672
0.869246376561 0.8698156682
-0.000569 diff smaller

2 0.489434906712 0.999877799512
0.869204665758 0.8698156682
-0.000611 diff smaller

2 0.489494723206 0.999885588796
0.869243612179 0.8698156682
-0.000572 diff smaller

2 0.489550733295 0.999866629795
0.869148817175 0.8698156682
-0.000667 diff smaller

2 0.489616033486 0.999759522789
0.871018054255 0.8698156682
0.001202 diff larger

2 0.489498291988 0.999856598225
0.869098659324 0.8698156682
-0.000717 diff smaller

2 0.489568496979 0.9999
0.869614687695 0.8698156682
-0.000201 diff smaller
</code></pre></div></div>

<p>Overall, it seems this is all just used to generate some deltas that are close, but not on-point to the delta between each discrete step of two adjacent log function values. The purpose is that in the next script, these deltas get used to create an increasingly uncertain weather forecast for the next 24h (game horizon in powertac) without going off-the-charts. I will ask my supervisor what exactly the motivation behind those deltas is but for now, let’s assume they are given (as they are in the forecast generation scripts anyways)</p>

<h2 id="current-implementation-creating-forecast-data">Current implementation: Creating Forecast Data</h2>

<p>This script <a href="https://github.com/powertac/powertac-weather-server/blob/master/scripts/create_forecast_data.py">create_forecast_data.py</a>
works as follows (pseudo-code)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#[temp,speed,dir,cloud]
taus = np.zeros((4,24)) #4x24 matrix
origin = date("20090101")

while origin &lt; end_date: #sequential

    weather = get_48h_weather() #48 sql queries in here
    taus = np.zeros((4,24))

    # make deviations
    for i in range(24):
        taus = taus[:,i-1] + np.random.normal(0, DELTAS[i],4) #shortened by me

    for i in range(24): #seq again
        weather_date = origin + hours(1)
        for j in range(24): #24^2*len(dates) seq iterations
            forecast_date = weather_date + hours(j+1)

            fc = (weather[forecast_date] + [2,1,10,0.1])*taus
            #fixing fcs to keep them in bounds (according to previous code)
            fc[1] = max(min(fc[1],19),0) #wind e [0,19]
            fc[2] = int((fc[2]) % 360)   #direction 360 deg
            fc[3] = max(min(cloud,1),0)  #cloud cover e [0,1]

            #insert into db ...

        #db commit
    origin += hours(1)
</code></pre></div></div>

<p>So this is a condensed pseudo version, but the process is the same</p>

<ul>
  <li>iterate over all days
    <ul>
      <li>iterate over each hour
        <ul>
          <li>generate 24h of forecast data
            <ul>
              <li>insert each forecast into database</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>Wow. That’s 630720 insert operations. No wonder, this is slow.</p>

<h3 id="weatherbug">Weatherbug?</h3>

<p>The weather taus are actually reused. The forecast at 00:00 for 24:00 uses the same error as the forecast at 24:00 for 24:00+1(day). So A smart client could take the forecast for 24:00 at 00:00 and compare it with the actual values of 24:00 to then derive the taus for the 24h forecast of the next day. Any following forecast can then be error corrected and therefore is on-spot. In my eyes this is a flaw in the simulation. I contacted the team regarding this.</p>

<h3 id="python-only-rewrite-zip--xml">Python only rewrite zip &gt; xml</h3>

<p>Since I just want xml in the end, I’ll skip the whole DB round-trip and <!-- TODO ???--> vectorize some operations while we’re at it. The basic concept could be this:</p>

<ul>
  <li>create method for generating 24 forecasts for each timeslot i based on [i+1:i+25] items in the list</li>
  <li>apply method on all elements either in sequence or to really pump up the speed in parallel (or even on GPU)</li>
</ul>

<p>The new implementation can download all data for 2000-today from the server, extract it and turn 3 years of weather reports into 3 years worth of forecast data based on the forecast generation approach in under a minute. That’s a LOT better than before. Why? Well it’s all in-memory and doesn’t do any I/O ops. The forecasts seem alright, as the graphic below shows</p>

<p><img src="http://pascalbrokmeier.de/images/posts/2018-02-12/simulations.png" alt="" width="800" height="1200" crossorigin="anonymous" /></p>

<p>All forecasts are along the lines of the actual weather but with some error up and down the spectrum, with the errors getting bigger as time progresses. This algorithm is directly taken from the previous implementation so it’s not my work. But it seems to provide a decent forecast with some logarithmic error distribution.</p>

<hr />
<h2 id="bottom-line">Bottom line</h2>
<p>The new implementation can be found <a href="https://github.com/pascalwhoop/powertac-weather-python-v2">on GitHub</a>. It is likely though that I will rewrite most of it again. I talked to John, the “father” of powertac and he told me he’s crawling most data from <a href="https://www.aerisweather.com/">aeris</a> and generating a <a href="http://www.cs.umn.edu/~jcollins/weather_records.json">json file</a> from it. But he also expressed interest in me taking on the weather server. It seems so as if it would be welcomed if I make aweather-server that can generate this on a regular basis. I could therefore use the <a href="https://darksky.net/dev/docs#api-request-types">darksky.net api</a> and generate data by polling their API (1000x a day is free). If I poll their API on a cloud machine once every hour for say 40 cities, I can stay under 1000 requests a day and collect enough data to supply the community with solid weather simulation data.</p>

<p>To be continued …</p>

        </div>
    </div>

</section>


      </div>

      <footer id="footer">
    <div class="inner">
        <h3>Homepage of Pascal Brokmeier</h3>
        <p>Check out my about page for more, read my blog or watch me code on YouTube or just take a picture of mine for your wallpaper. I share everything for free and really enjoy good conversations about meaningful topics. Let me know if you have something to talk about.
</p>
        <ul class="icons">

            
            <li><a href="mailto:public@pascalbrokmeier.de" class="icon alt fa-envelope"></a></li>
            
            
            <li><a href="https://twitter.com/PascalBrokmeier" class="icon alt fa-twitter" rel="me"><span class="label">Twitter</span></a>
            </li>
            
            
            <li><a href="https://github.com/pascalwhoop" class="icon alt fa-github" rel="me"><span class="label">GitHub</span></a>
            </li>
            
            <!--
            <li><a href="#" class="icon alt fa-facebook"><span class="label">Facebook</span></a></li>
            <li><a href="#" class="icon alt fa-instagram"><span class="label">Instagram</span></a></li>
            <li><a href="#" class="icon alt fa-linkedin"><span class="label">LinkedIn</span></a></li>
            -->

        </ul>
        <ul class="copyright">
            <li><span class="copyleft">&copy;</span>
                
                Homepage of Pascal Brokmeier
                
            </li>
            <li>Design: some of <a href="https://html5up.net">HTML5 UP</a> adopted by me</li>
            <li><a href="/sitemap.xml">Sitemap</a></li>
            <li><a href="/legal">Legal</a></li>
        </ul>
    </div>
</footer>

<script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>
<script src="/assets/js/jquery.scrolly.min.js"></script>
<script src="/assets/js/jquery.scrollex.min.js"></script>
<script src="/assets/js/skel.min.js"></script>
<script src="/assets/js/util.js"></script>
<script src="/assets/js/articles.js"></script>
<!--[if lte IE 8]>
<script  src="assets/js/ie/respond.min.js"></script><![endif]-->
<script src="/assets/js/main.js"></script>


<script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>



  </body>

</html>
